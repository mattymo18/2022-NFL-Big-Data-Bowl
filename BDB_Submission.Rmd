---
title: "2022 NFL Big Data Bowl Submission"
author: "Matt Johnson"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(reactable)
library(htmltools)
library(knitr)
library(Matrix)
library(kableExtra)
```

```{r, include = F}

Sparse.Df <- readMM("Derived_Data/Sparse.Matrix.txt")

punts <- read_csv("Derived_Data/clean.plays.csv")

player.index <- read_csv("Derived_Data/player.index.csv")

#first lets attach the unique newIds to the Sparse.Df as it's own column

#we need to convert the sparse matrix into a large data frame

Sparse.tib <- as.data.frame(as.matrix(Sparse.Df))

#now we can figure out which column corresponds to which player with the player.index

col.names <- player.index %>%
    arrange(ColIdx)  %>%
    distinct(nflId, ColIdx) %>%
    select(nflId)

names(Sparse.tib) <- as.character(unlist(col.names))

#now we just put in all the variables we need

Sparse.tib.named <- Sparse.tib %>% 
  mutate(newId = unique(player.index$newId)) %>% 
  mutate(NYG = punts$NetYardsGained) %>% 
  mutate(Field.Pos = punts$field.pos) %>% 
  mutate(Pen.Yrds = punts$penalty.yards.clean) %>% 
  select(newId,Field.Pos, everything())
```

## Introduction

This paper introduces a new metric for assessing player contribution during a punt called Regularized Adjusted Field Position Contribution (RAFPC). We adapt a metric historically used in basketball called Adjusted Plus-Minus (APM); this metric adjusts the conventional Plus-Minus metric to control for every player on the court during a stint where the same 10 players are on the court. In the NFL punt return case, this is simply the 22 players on the field during a punt. In classic APM for basketball, the variable of interest is the points scored during the stint, this will not work for football as points are rarely scored during punts. Instead, we build a field position metric to represent success during a punt return. Field position is the difference between where the team punted from and where the ball ended up in the resulting return. We believe this encapsulates the success of a punt. This new metric can be used to rank players regardless of their position on how much they positively contribute towards the success of their team in punting situations. The definition of contribution will be discussed later in the methodlogy section, but for now it is a positive number indicating how much that individual helped their team.

## Data
The final dataframe used for analysis had 5697 rows and 2007 columns. Each row is a play where one team successfully punted the ball away to the other team. Each column represents a player that could have been on the field during any punt for which we had tracking data. Each cell corresponding to a player is a 1 if the player's team is receiving the punt, a -1 if the player's team is punting, and a 0 if the player is not on the field. The reason we code the punting team as -1 is so they will still have positive coefficients in the regression analysis. This dataframe is inherently rank deficient and therefore we cannot use standard linear regression, rather we must use a penalized approach so the sample covariance matrix is invertible. The dataframe is rank deficient because if we removed a players column, we would still know whether he was on the field on offense or defense simply using the rest of the columns. According to this, the matrix does not have full rank. 

Below is a glimpse of the dataframe. 

```{r, echo = F}
kable(Sparse.tib.named[1:10, 1:10]) %>% 
  kable_styling(full_width = T)
```

#### Exploratory Data Analysis

We completed an exploratory data analysis to help us visualize the dataframe we will use for the modeling section. Below we see a histogram and a boxplot for the response variable: Field Position. We find it is approximately normally distributed with mean -40.

```{r, echo = F, message = F}
Sparse.tib.named %>% 
  rename("Field Position" = Field.Pos) %>% 
  pivot_longer(cols = c(`Field Position`), 
               names_to = "Variable", values_to = "Value") %>% 
  select(Variable, Value) %>% 
  ggplot(aes(x = Value)) +
  geom_histogram(fill='#A4A4A4', color="purple") +
  theme_bw() +
  labs(y = "Count", 
       title = "Field Position Histogram")
```

```{r, echo = F}
Sparse.tib.named %>% 
  rename("Field Position" = Field.Pos) %>% 
  pivot_longer(cols = c(`Field Position`), 
               names_to = "Variable", values_to = "Value") %>% 
  select(Variable, Value) %>% 
  ggplot(aes(x = Value, y = Variable)) +
  geom_boxplot(fill='#A4A4A4', color="purple") +
  geom_jitter(color = "purple", alpha = .1) +
  theme_bw() +
  coord_flip() +
  labs(y = element_blank(), 
       title = "Field Position Boxplot")
```

## Methodology

We employ a similar methodology as in Dan Rosenbaum's paper about adjusted plus minus found [HERE](http://www.82games.com/comm30.htm). In order to quantify a player's contribution while controlling for everyone on his team as well as everyone playing against him we use a penalized Ridge regression and use the beta coefficients as our value for "Contribution". We use a penalized regression to combat the rank deficiency of the dataframe described in the **Data** section. Specifically, we want to use a Ridge regression because we do not want to shrink anyone player's coefficient to 0 as we would not be able to rank their contribution. By running this type of regression we are able to evaluate players regardless of their position and assess how much they contributed during the play. 

## Results

Below is the final table showing the top 20 players with regard to positive contribution towards field position (min 50 snaps). We need to adjust the table to account for snap-count as there were a few players only on the field during a single return that happened to result in a big play. It is interesting to see that the model finds a variety of players on offense and defense contributing towards a successful special teams play. We also see the model finds a few specialty return players that have direct contribution to the ball moving downfield. 

```{r, include = F}
#bring in data
DF <- read_csv("Derived_Data/top20.csv")

#they make us build this reactable in the RMD
#lets try to use a reactable

#first build a function to make a nice barchart, we want there to be a nice barchart in this table

bar_chart <- function(label, width = "100%", height = "16px", fill = "#00bfc4", background = NULL) {
  bar <- div(style = list(background = fill, width = width, height = height))
  chart <- div(style = list(flexGrow = 1, marginLeft = "8px", background = background), bar)
  div(style = list(display = "flex", alignItems = "center"), label, chart)
}

#ok this is a great graph, lets save it

reactable1 <- DF %>% 
  select(nflId, Name, Position, Contribution, Snaps) %>% 
  reactable(
    columns = list(
      Contribution = colDef(name = "Contribution", align = "left", cell = function(value) {
        width <- paste0(value / max(DF$Contribution) * 100, "%")
        bar_chart(value, width = width, fill = "#7c5295", background = "#e1e1e1")
      }), 
      Snaps = colDef(name = "Sanps", align = "left", cell = function(value) {
        width <- paste0(value / max(DF$Snaps) * 100, "%")
        bar_chart(value, width = width, fill = "#56a0d3", background = "#e1e1e1")
      })
    )
  )
```

```{r, echo = F}
reactable1
```

## Conclusions

We have successfully developed a new metric to assess any player's contribution during punting plays: RAFPC. This type of metric is extremely useful for on-field decision makers as it can be used to decide which players should be on the field during a punt and it makes it easy to compare across different positions. Also, we can use this metric to rank incoming players during the NFL Draft and help GM's decide who they should choose. Future work should apply this APM model to other play types. In theory, we should be able to apply this model to any play since the same 22 players are always on the field during a play. Future work should also include analysis on fumbles. A major drawback this analysis is that we remove fumbles when in reality fumbles on special teams plays are some of the most impactful and can instantly change a game. In conclusion, RAFPC can be a useful metric for ranking players across different positions for their contribution during punt plays with regard to relative field position.